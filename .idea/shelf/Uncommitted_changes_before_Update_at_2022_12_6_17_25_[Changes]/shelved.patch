Index: app/src/main/java/com/example/can301/TableActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.can301;\r\n\r\nimport android.app.Activity;\r\nimport android.content.Intent;\r\nimport android.content.SharedPreferences;\r\nimport android.content.res.Resources;\r\nimport android.os.Build;\r\nimport android.os.Bundle;\r\nimport android.view.Gravity;\r\nimport android.view.View;\r\nimport android.view.Window;\r\nimport android.widget.Button;\r\nimport android.widget.ImageView;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.annotation.RequiresApi;\r\n\r\nimport com.example.can301.net.NetAgent;\r\nimport com.example.can301.net.OkHttpUtils;\r\nimport com.example.can301.utilities.FastJsonUtils;\r\n\r\nimport java.time.LocalDate;\r\nimport java.time.ZoneId;\r\nimport java.util.ArrayList;\r\nimport java.util.Date;\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\n\r\npublic class TableActivity extends Activity {\r\n    private int startIndex;\r\n    private int seatNumber;\r\n    private String type;\r\n    private TextView testTV;\r\n    private ImageView[] seatList;\r\n    private int[] seatStatus;\r\n    private ArrayList<Integer> seatIDs;\r\n    private String backendUrl;\r\n    private int taken = 0;\r\n    private int ava = 0;\r\n    private int unk = 0;\r\n    private Button checkinBtn;\r\n    private TextView tableStats;\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        seatIDs = new ArrayList<Integer>();\r\n        // 隐藏标题栏\r\n        requestWindowFeature(Window.FEATURE_NO_TITLE);\r\n        //setContentView(R.layout.activity_table_v);\r\n        backendUrl = \"http://47.94.44.163:8080\";\r\n        Intent intent = getIntent();\r\n        Bundle infoBundle = intent.getExtras();\r\n        // 在res中获取\r\n            Resources res =getResources();\r\n            String[] typeArray= res.getStringArray(R.array.tableType);\r\n        startIndex = Integer.parseInt(\r\n                infoBundle.getString(\"startIndex\"));\r\n        seatNumber = Integer.parseInt(\r\n                infoBundle.getString(\"seatNumber\"));;\r\n        type = infoBundle.getString(\"type\");\r\n\r\n        if(type.equals(\"0\"))\r\n            setContentView(R.layout.activity_table_v);\r\n        else if(type.equals(\"1\"))\r\n            setContentView(R.layout.activity_table_h);\r\n        else\r\n            setContentView(R.layout.activity_table_sqr);\r\n        checkinBtn = findViewById(R.id.checkinBtn);\r\n        testTV = findViewById(R.id.testView);\r\n        testTV.setText(type + \",\" + startIndex + \", \" + seatNumber);\r\n        tableStats = findViewById(R.id.tableStats);\r\n        seatList = new ImageView[seatNumber];\r\n        findSeat();\r\n        //\r\n        try{\r\n            initSeatStatus();\r\n        }\r\n        catch (Exception e){\r\n            e.printStackTrace();\r\n        }\r\n        checkinBtn.setOnClickListener(this::onCheckInClick);\r\n        assignSeatBtn(seatList);\r\n        readID();\r\n    }\r\n\r\n    private void gainCoin(String id, int credit){\r\n            HashMap hashMap = new HashMap();\r\n            hashMap.put(\"id\", id);\r\n            hashMap.put(\"salary\", String.valueOf(credit));\r\n            //System.out.println(getActivity());\r\n            OkHttpUtils.getSoleInstance().doPostForm(backendUrl + \"/user/getcash/\", new NetAgent() {\r\n                @Override\r\n                public void onSuccess(String result) {\r\n                    Map<String, String> map = FastJsonUtils.stringToCollect(result);\r\n                    String cash = String.valueOf(map.get(\"cash\"));\r\n                    if (map.get(\"status\").equals(\"200\")) {\r\n                        //Toast.makeText(getActivity().getApplicationContext(), \"get cash\", Toast.LENGTH_SHORT).show();\r\n                    } else {\r\n                        Toast toastCenter = Toast.makeText(getApplicationContext(), \"no\", Toast.LENGTH_SHORT);\r\n                        toastCenter.setGravity(Gravity.CENTER, 0, 0);\r\n                        toastCenter.show();\r\n                    }\r\n                }\r\n                @Override\r\n                public void onError(Exception e) {\r\n                        e.printStackTrace();\r\n                        Toast center = Toast.makeText(getApplicationContext(), \"network failure\", Toast.LENGTH_SHORT);\r\n                        center.setGravity(Gravity.CENTER, 0, 0);\r\n                        center.show();\r\n                }\r\n            },hashMap,this);\r\n    }\r\n\r\n    @RequiresApi(api = Build.VERSION_CODES.O)\r\n    public static boolean isSameDay(Date date1, Date date2) {\r\n        LocalDate localDate1 = date1.toInstant()\r\n                .atZone(ZoneId.systemDefault())\r\n                .toLocalDate();\r\n        LocalDate localDate2 = date2.toInstant()\r\n                .atZone(ZoneId.systemDefault())\r\n                .toLocalDate();\r\n        return localDate1.isEqual(localDate2);\r\n    }\r\n\r\n    @RequiresApi(api = Build.VERSION_CODES.O)\r\n    private void onCheckInClick(View view) {\r\n        int credit = 0;\r\n        String userid = \"1\";\r\n        SharedPreferences userpref = getSharedPreferences(\"config\", MODE_PRIVATE);\r\n        userid = userpref.getString(\"id\", \"1\");\r\n        SharedPreferences mypref = getSharedPreferences(\"tab\", MODE_PRIVATE);\r\n        Date currdate = new Date(); //or simply new Date();\r\n        Date archivedDate = new Date(mypref.getLong(\"date\", 0));\r\n\r\n        //!\r\n        // one seat 5 credits by checkin Commit (max 25), global time recorded, uncomment condition to activate date detection\r\n        if(!isSameDay(currdate,archivedDate)){\r\n            String stringStatus =  mypref.getString(\"statuslist\", \"null\");\r\n            for (int i = startIndex; i < startIndex+seatNumber; i++) {\r\n                if(seatStatus[i] != Integer.parseInt(stringStatus.substring(i-startIndex,i-startIndex+1))){\r\n                    credit += 5;\r\n                }\r\n            }\r\n            if (credit > 25) credit = 25;\r\n            int old_ava = mypref.getInt(\"available\", 0);\r\n            int old_unk = mypref.getInt(\"unknown\", 0);\r\n            int old_tak = mypref.getInt(\"taken\", 0);\r\n            long millis = currdate.getTime();\r\n            SharedPreferences.Editor editor = mypref.edit();\r\n            editor.putLong(\"date\", millis);\r\n            gainCoin(userid, credit);\r\n            Toast.makeText(getApplicationContext(), \"you earned \" + credit, Toast.LENGTH_SHORT).show();\r\n            Intent intent = new Intent(TableActivity.this, mainTestActivity.class);\r\n            startActivity(intent);\r\n        }\r\n        else {\r\n            Toast.makeText(getApplicationContext(), \"You have taken todays credit!\", Toast.LENGTH_SHORT).show();\r\n            Intent intent = new Intent(TableActivity.this, mainTestActivity.class);\r\n            startActivity(intent);\r\n        }\r\n\r\n        //System.out.println(old_tak + \", \" + old_ava + \", \"+ old_unk + \", \" + stringStatus + \", \" + myDate);\r\n    }\r\n\r\n    private void findSeat(){\r\n        // 数组越界了就看这里\r\n        int j = 0;\r\n        for (int i = 1; i < seatNumber+1; i++) {\r\n            String seatID = \"seat\" + i;;\r\n            //System.out.println(seatID);\r\n            int resID = getResources().getIdentifier(seatID, \"id\", getPackageName());\r\n            // System.out.println(resID);\r\n            seatIDs.add(resID);\r\n            ImageView seat = (ImageView) findViewById(resID);\r\n            //System.out.println(seat.toString());\r\n            seatList[j] = seat;\r\n            j++;\r\n        }\r\n    }\r\n\r\n    private void assignSeatBtn(@NonNull ImageView[] seatList){\r\n        for (ImageView seat: seatList) {\r\n            seat.setOnClickListener(this::onSeatClick);\r\n        }\r\n    }\r\n\r\n    private void onSeatClick(View view) {\r\n        int id = view.getId();\r\n        int specSeatIdx = startIndex;\r\n        String staticSeatId = \"\";\r\n        int status = 0;\r\n        int localID = 0;\r\n        for (int i = 0; i<seatIDs.size(); i++) {\r\n            if(id == seatIDs.get(i)){\r\n                specSeatIdx += i;\r\n                staticSeatId = \"seat\" + (i+1);\r\n                status = seatStatus[startIndex+i];\r\n                localID = i;\r\n            }\r\n        }\r\n        changeSeatStatus(specSeatIdx+1,999);\r\n        getSeatStatus();\r\n    }\r\n\r\n    private void initSeatStatus(){\r\n        taken = 0;\r\n        ava = 0;\r\n        unk = 0;\r\n        HashMap hashMap = new HashMap();\r\n        OkHttpUtils.getSoleInstance().doPostForm(backendUrl + \"/seat/listseat\", new NetAgent() {\r\n            @Override\r\n            public void onSuccess(String result) {\r\n                Map<String, String> map = FastJsonUtils.stringToCollect(result);\r\n                String status = map.get(\"status\");\r\n                String message = map.get(\"status\");\r\n                String a = map.get(\"seatstatus\");\r\n                String statusKey = \"\";\r\n                Object[] b = FastJsonUtils.toArray(a);\r\n                int[] ss = new int[b.length];\r\n                for (int i = 0; i < ss.length; i++) {\r\n                    ss[i] = Integer.parseInt(b[i].toString());\r\n                    statusKey += b[i].toString();\r\n                }\r\n                seatStatus = ss;\r\n                // System.out.println(seatStatus);\r\n                if (status.equals(\"200\")) {\r\n                } else {\r\n                    Toast toastCenter = Toast.makeText(getApplicationContext(), message, Toast.LENGTH_SHORT);\r\n                    toastCenter.setGravity(Gravity.CENTER, 0, 0);\r\n                    toastCenter.show();\r\n                }\r\n                int bias=0;\r\n                for (ImageView seat: seatList) {\r\n                    if(seatStatus[startIndex+bias]==0){\r\n                        taken++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.redseat));\r\n                    }\r\n                    else if(seatStatus[startIndex+bias]==1){\r\n                        ava++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.greenseat));\r\n                    }\r\n                    else if(seatStatus[startIndex+bias]==2){\r\n                        unk++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.grayseat));\r\n                    }else{\r\n                        seat.setImageDrawable(getDrawable(R.drawable.grayseat));\r\n                        unk++;\r\n                    }\r\n                    bias++;\r\n                }\r\n                tableStats.setText(\"// \"+ taken + \" taken, \" + ava + \" available, \"+ unk +\" unknown. //\");\r\n                SharedPreferences mypref = getSharedPreferences(\"tab\", MODE_PRIVATE);\r\n                SharedPreferences.Editor editor = mypref.edit();\r\n                editor.putString(\"statuslist\", statusKey.substring(startIndex, startIndex + seatNumber));\r\n                editor.putInt(\"available\", ava);\r\n                editor.putInt(\"unknown\", unk);\r\n                editor.putInt(\"taken\", taken);\r\n                editor.apply();\r\n            }\r\n            @Override\r\n            public void onError(Exception e) {\r\n                e.printStackTrace();\r\n                Toast center = Toast.makeText(getApplicationContext(), \"network failure\", Toast.LENGTH_SHORT);\r\n                center.setGravity(Gravity.CENTER, 0, 0);\r\n                center.show();\r\n            }\r\n        },hashMap,this);\r\n    }\r\n\r\n    private void getSeatStatus(){\r\n        taken = 0;\r\n        ava = 0;\r\n        unk = 0;\r\n        HashMap hashMap = new HashMap();\r\n        OkHttpUtils.getSoleInstance().doPostForm(backendUrl + \"/seat/listseat\", new NetAgent() {\r\n            @Override\r\n            public void onSuccess(String result) {\r\n                Map<String, String> map = FastJsonUtils.stringToCollect(result);\r\n                String status = map.get(\"status\");\r\n                String message = map.get(\"status\");\r\n                String a = map.get(\"seatstatus\");\r\n                Object[] b = FastJsonUtils.toArray(a);\r\n                int[] ss = new int[b.length];\r\n                for (int i = 0; i < ss.length; i++) {\r\n                    ss[i] = Integer.parseInt(b[i].toString());\r\n                }\r\n                seatStatus = ss;\r\n                // System.out.println(seatStatus);\r\n                if (status.equals(\"200\")) {\r\n                    //Toast.makeText(getApplicationContext(), \"Updated seat info\", Toast.LENGTH_SHORT).show();\r\n                } else {\r\n                }\r\n                int bias=0;\r\n                for (ImageView seat: seatList) {\r\n                    if(seatStatus[startIndex+bias]==0){\r\n                        taken++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.redseat));\r\n                    }\r\n                    else if(seatStatus[startIndex+bias]==1){\r\n                        ava++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.greenseat));\r\n                    }\r\n                    else if(seatStatus[startIndex+bias]==2){\r\n                        unk++;\r\n                        seat.setImageDrawable(getDrawable(R.drawable.grayseat));\r\n                    }else{\r\n                        seat.setImageDrawable(getDrawable(R.drawable.grayseat));\r\n                        unk++;\r\n                    }\r\n                    bias++;\r\n                }\r\n                tableStats.setText(\"// \"+ taken + \" taken, \" + ava + \" available, \"+ unk +\" unknown. //\");\r\n            }\r\n            @Override\r\n            public void onError(Exception e) {\r\n                e.printStackTrace();\r\n                Toast center = Toast.makeText(getApplicationContext(), \"network failure\", Toast.LENGTH_SHORT);\r\n                center.setGravity(Gravity.CENTER, 0, 0);\r\n                center.show();\r\n            }\r\n        },hashMap,this);\r\n\r\n    }\r\n    private void changeSeatStatus(int id,int qrresult){\r\n        HashMap hashMap = new HashMap();\r\n        hashMap.put(\"seatIndex\",String.valueOf(id));\r\n        hashMap.put(\"qrresult\",String.valueOf(qrresult));\r\n        OkHttpUtils.getSoleInstance().doPostForm(backendUrl + \"/seat/changeSteatStatus\", new NetAgent() {\r\n            @Override\r\n            public void onSuccess(String result) {\r\n                Map<String, String> map = FastJsonUtils.stringToCollect(result);\r\n                String status = map.get(\"status\");\r\n                if (status.equals(\"200\")) {\r\n                } else {\r\n                }\r\n                getSeatStatus();\r\n            }\r\n            @Override\r\n            public void onError(Exception e) {\r\n                e.printStackTrace();\r\n                Toast center = Toast.makeText(getApplicationContext(), \"network failure\", Toast.LENGTH_SHORT);\r\n                center.setGravity(Gravity.CENTER, 0, 0);\r\n                center.show();\r\n            }\r\n        },hashMap,this);\r\n\r\n    }\r\n\r\n    public void readID(){\r\n        SharedPreferences mypref = getSharedPreferences(\"config\", MODE_PRIVATE);\r\n        String id = mypref.getString(\"id\", \"id = x\");\r\n        testTV.setText(\"id = \" + id);\r\n    }\r\n\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/can301/TableActivity.java b/app/src/main/java/com/example/can301/TableActivity.java
--- a/app/src/main/java/com/example/can301/TableActivity.java	(revision d4af7c8ff1b9e738a31851504108a193bec9861f)
+++ b/app/src/main/java/com/example/can301/TableActivity.java	(date 1670317804532)
@@ -42,6 +42,7 @@
     private int unk = 0;
     private Button checkinBtn;
     private TextView tableStats;
+    @RequiresApi(api = Build.VERSION_CODES.O)
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
@@ -115,14 +116,9 @@
 
     @RequiresApi(api = Build.VERSION_CODES.O)
     public static boolean isSameDay(Date date1, Date date2) {
-        LocalDate localDate1 = date1.toInstant()
-                .atZone(ZoneId.systemDefault())
-                .toLocalDate();
-        LocalDate localDate2 = date2.toInstant()
-                .atZone(ZoneId.systemDefault())
-                .toLocalDate();
-        return localDate1.isEqual(localDate2);
-    }
+            int days = (int) ((date2.getTime() - date1.getTime()) / (1000 * 3600 * 24));
+            return days < 1;
+        }
 
     @RequiresApi(api = Build.VERSION_CODES.O)
     private void onCheckInClick(View view) {
@@ -133,7 +129,9 @@
         SharedPreferences mypref = getSharedPreferences("tab", MODE_PRIVATE);
         Date currdate = new Date(); //or simply new Date();
         Date archivedDate = new Date(mypref.getLong("date", 0));
-
+        long millis = currdate.getTime();
+        SharedPreferences.Editor editor = mypref.edit();
+        editor.putLong("date", millis);
         //!
         // one seat 5 credits by checkin Commit (max 25), global time recorded, uncomment condition to activate date detection
         if(!isSameDay(currdate,archivedDate)){
@@ -147,9 +145,6 @@
             int old_ava = mypref.getInt("available", 0);
             int old_unk = mypref.getInt("unknown", 0);
             int old_tak = mypref.getInt("taken", 0);
-            long millis = currdate.getTime();
-            SharedPreferences.Editor editor = mypref.edit();
-            editor.putLong("date", millis);
             gainCoin(userid, credit);
             Toast.makeText(getApplicationContext(), "you earned " + credit, Toast.LENGTH_SHORT).show();
             Intent intent = new Intent(TableActivity.this, mainTestActivity.class);
